"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.HttpRouter = void 0;
const http_response_1 = require("./http-response");
const http_request_1 = require("./http-request");
const MAX_URL_SEGMENTS = 100;
/**
 * int64 (ish) Bitwise OR
 * @param v1
 * @param v2
 */
function OR(v1, v2) {
    var hi = 0x80000000;
    var low = 0x7fffffff;
    var hi1 = ~~(v1 / hi);
    var hi2 = ~~(v2 / hi);
    var low1 = v1 & low;
    var low2 = v2 & low;
    var h = hi1 | hi2;
    var l = low1 | low2;
    return h * hi + l;
}
/**
 * int64 (ish) Bitwise AND
 * @param v1
 * @param v2
 */
function AND(v1, v2) {
    var hi = 0x80000000;
    var low = 0x7fffffff;
    var hi1 = ~~(v1 / hi);
    var hi2 = ~~(v2 / hi);
    var low1 = v1 & low;
    var low2 = v2 & low;
    var h = hi1 & hi2;
    var l = low1 & low2;
    return h * hi + l;
}
/**
 * Given an array
 *
 * The elements are compared `comp`. The elements in the range shall already be
 * sorted according to this same criterion (`comp`), or at least partitioned
 * with respect to val.
 *
 * The function optimizes the number of comparisons performed by comparing
 * non-consecutive elements of the sorted range.
 *
 * The index into the `array` returned by this function cannot be equivalent to
 * `val`, only greater.
 *
 * On average, logarithmic in the distance of the length of the array: Performs
 * approximately `log2(N)+1` element comparisons (where `N` is this length).
 *
 * @param array
 * @param val Value of the upper bound to search for in the range.
 * @param comp A function that accepts two arguments (the first is always
 * `val`, and the second from the given `array`, and returns bool. The value
 * returned indicates whether the first argument is considered to go before the
 * second.
 *
 * @returns The index to the upper bound position for `val` in the range. If no
 * element in the range compares greater than `val`, the function returns
 * `array.length`.
 */
function upperBound(array, val, comp) {
    let count = array.length;
    let first = 0;
    let offset = 0;
    while (count > 0) {
        let step = (count / 2) | 0;
        offset += step;
        if (!comp(val, array[offset])) {
            first = ++offset;
            count -= step + 1;
        }
        else {
            count = step;
            offset = first;
        }
    }
    return first;
}
class Node {
    constructor(name) {
        this.name = name;
        this.children = [];
        this.handlers = [];
        this.isHighPriority = false;
    }
}
/**
 * Basically a pre-allocated stack
 */
class RouteParameters {
    constructor() {
        this.params = Array(MAX_URL_SEGMENTS).fill("");
        this.paramsTop = 0;
    }
    reset() {
        this.paramsTop = -1;
    }
    push(param) {
        this.params[++this.paramsTop] = param;
    }
    pop() {
        this.paramsTop--;
    }
}
var Priority;
(function (Priority) {
    Priority[Priority["HIGH_PRIORITY"] = 3489660928] = "HIGH_PRIORITY";
    Priority[Priority["MEDIUM_PRIORITY"] = 3758096384] = "MEDIUM_PRIORITY";
    Priority[Priority["LOW_PRIORITY"] = 4026531840] = "LOW_PRIORITY";
})(Priority || (Priority = {}));
/**
 * Handler ids are 32-bit
 */
const HANDLER_MASK = 0x0fffffff;
class HttpRouter {
    constructor() {
        this.methods = [
            "get",
            "post",
            "head",
            "put",
            "delete",
            "connect",
            "options",
            "trace",
            "patch"
        ];
        this.HIGH_PRIORITY = Priority.HIGH_PRIORITY;
        this.MEDIUM_PRIORITY = Priority.MEDIUM_PRIORITY;
        this.LOW_PRIORITY = Priority.LOW_PRIORITY;
        /**
         * The matching tree
         */
        this.root = new Node("rootNode");
        this.routeParameters = new RouteParameters();
        this.priority = new Map();
        this.handlers = [];
        this.currentUrl = null;
        this.urlSegmentVector = [];
        this.urlSegmentTop = 0;
        this.userData = null;
        let p = 0;
        for (const method of this.methods) {
            this.priority.set(method, p++);
        }
    }
    getParameters() {
        return [this.routeParameters.paramsTop, this.routeParameters.params];
    }
    setUserData(req, res) {
        this.userData = {
            httpRequest: new http_request_1.HttpRequest(req),
            httpResponse: new http_response_1.HttpResponse(res, req)
        };
    }
    getUserData() {
        return this.userData;
    }
    /**
     * Fast path
     */
    route(method, url) {
        if (!this.userData) {
            throw new Error("User Data not set in Http Router; this should not happen.");
        }
        // Reset url parsing cache
        this.setUrl(url);
        this.routeParameters.reset();
        // Begin by finding the method node
        for (let p of this.root.children) {
            if (p.name === method) {
                /* Then route the url */
                return this.executeHandlers(p, 0, this.userData);
            }
        }
        /* We did not find any handler for this method and url */
        return false;
    }
    add(methods, pattern, handler, priority = Priority.MEDIUM_PRIORITY) {
        for (let method of methods) {
            // Lookup method
            let node = this.getNode(this.root, method, false);
            // Iterate over all segments
            this.setUrl(pattern);
            for (let i = 0; !this.getUrlSegment(i)[1]; i++) {
                node = this.getNode(node, this.getUrlSegment(i)[0], priority === Priority.HIGH_PRIORITY);
            }
            // Insert handler in order sorted by priority (most significant 1 byte)
            const size = this.handlers.length;
            const bit = OR(priority, size);
            const position = upperBound(node.handlers, bit, (a, b) => {
                return a < b;
            });
            node.handlers.splice(position, 0, bit);
        }
        // Store this handler
        this.handlers.push(handler);
    }
    /**
     * Executes as many handlers it can
     */
    executeHandlers(parent, urlSegment, _userData) {
        this.userData = _userData;
        const [segment, isStop] = this.getUrlSegment(urlSegment);
        // If we are on STOP, return where we may stand
        if (isStop) {
            // We have reached accross the entire URL with no stoppage, execute
            for (let handler of parent.handlers) {
                if (this.handlers[AND(handler, HANDLER_MASK)](this)) {
                    return true;
                }
            }
            // We reached the end, so go back
            return false;
        }
        for (let p of parent.children) {
            if (p.name.length && p.name[0] === "*") {
                // Wildcard match (can be seen as a shortcut)
                for (let handler of p.handlers) {
                    if (this.handlers[handler & HANDLER_MASK](this)) {
                        return true;
                    }
                }
            }
            else if (p.name.length && p.name[0] === ":" && segment.length) {
                // Parameter match
                this.routeParameters.push(segment);
                if (this.executeHandlers(p, urlSegment + 1, this.userData)) {
                    return true;
                }
                this.routeParameters.pop();
            }
            else if (p.name == segment) {
                // Static match
                if (this.executeHandlers(p, urlSegment + 1, this.userData)) {
                    return true;
                }
            }
        }
        return false;
    }
    /**
     * Set URL for router. Will reset any URL cache
     * @param url
     */
    setUrl(url) {
        /* We expect to stand on a slash */
        this.currentUrl = url;
        this.urlSegmentTop = -1;
    }
    /**
     * Advance from parent to child, adding child if necessary
     * @param parent
     * @param child
     * @param isHighPriority
     */
    getNode(parent, child, isHighPriority) {
        for (let node of parent.children) {
            if (node.name === child && node.isHighPriority === isHighPriority) {
                return node;
            }
        }
        /* Insert sorted, but keep order if parent is root (we sort methods by priority elsewhere) */
        const newNode = new Node(child);
        newNode.isHighPriority = isHighPriority;
        const index = upperBound(parent.children, newNode, (a, b) => {
            if (a.isHighPriority !== b.isHighPriority) {
                return a.isHighPriority;
            }
            return b.name.length > 0 && parent !== this.root && b.name < a.name;
        });
        parent.children.splice(index, 0, newNode);
        return newNode;
    }
    /**
     * Lazily parse or read from cache
     * @param urlSegment
     */
    getUrlSegment(urlSegment) {
        if (urlSegment > this.urlSegmentTop && this.currentUrl !== null) {
            // Signal as STOP when we have no more URL or stack space
            if (!this.currentUrl.length || urlSegment > 99) {
                return ["", true];
            }
            // We always stand on a slash here, so step over it
            this.currentUrl = this.currentUrl.slice(1);
            let segmentLength = this.currentUrl.indexOf("/");
            if (segmentLength === -1) {
                segmentLength = this.currentUrl.length;
                // Push to url segment vector
                this.urlSegmentVector[urlSegment] = this.currentUrl.substr(0, segmentLength);
                this.urlSegmentTop++;
                // Update currentUrl
                this.currentUrl = this.currentUrl.substr(segmentLength);
            }
            else {
                // Push to url segment vector
                this.urlSegmentVector[urlSegment] = this.currentUrl.substr(0, segmentLength);
                this.urlSegmentTop++;
                // Update currentUrl
                this.currentUrl = this.currentUrl.substr(segmentLength);
            }
        }
        /* In any case we return it */
        return [this.urlSegmentVector[urlSegment], false];
    }
}
exports.HttpRouter = HttpRouter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC1yb3V0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZmFsbGJhY2svaHR0cC1yb3V0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbURBQStDO0FBQy9DLGlEQUE2QztBQVM3QyxNQUFNLGdCQUFnQixHQUFHLEdBQVksQ0FBQztBQUV0Qzs7OztHQUlHO0FBQ0gsU0FBUyxFQUFFLENBQUMsRUFBVSxFQUFFLEVBQVU7SUFDaEMsSUFBSSxFQUFFLEdBQUcsVUFBVSxDQUFDO0lBQ3BCLElBQUksR0FBRyxHQUFHLFVBQVUsQ0FBQztJQUNyQixJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDdEIsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3RCLElBQUksSUFBSSxHQUFHLEVBQUUsR0FBRyxHQUFHLENBQUM7SUFDcEIsSUFBSSxJQUFJLEdBQUcsRUFBRSxHQUFHLEdBQUcsQ0FBQztJQUNwQixJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDO0lBQ2xCLElBQUksQ0FBQyxHQUFHLElBQUksR0FBRyxJQUFJLENBQUM7SUFDcEIsT0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztBQUNwQixDQUFDO0FBRUQ7Ozs7R0FJRztBQUNILFNBQVMsR0FBRyxDQUFDLEVBQVUsRUFBRSxFQUFVO0lBQ2pDLElBQUksRUFBRSxHQUFHLFVBQVUsQ0FBQztJQUNwQixJQUFJLEdBQUcsR0FBRyxVQUFVLENBQUM7SUFDckIsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3RCLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUN0QixJQUFJLElBQUksR0FBRyxFQUFFLEdBQUcsR0FBRyxD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